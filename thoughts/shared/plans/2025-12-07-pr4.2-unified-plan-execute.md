# PR4.2: Unified Plan/Execute Architecture (Option B)

## Overview

Eliminate the text-only plan execution path (Path B) by enabling buffered tools during plan generation. This ensures the file list shown to users is **exact** - derived from the same tool calls that will execute on Proceed.

**Problem**: Currently, when `isPlan && !isConversational` routes to the "plan" route, tools are disabled. This creates text-only plans that require a second LLM call (`extractExpectedFilesViaLLM`) to predict files, which may differ from actual execution.

**Solution**: Enable buffered tools during plan generation. The AI will emit tool calls that get buffered (not executed), providing an exact file list. On Proceed, execute the buffered calls directly via Path A.

## Current State Analysis

### Two Execution Paths Today

| Path | Trigger | File List Source | Accuracy |
|------|---------|------------------|----------|
| **A (Buffered)** | `bufferedToolCalls.length > 0` | From stored tool calls | Exact |
| **B (Text-Only)** | `plan.description` only | LLM prediction | May differ |

### Key Code Locations

- **Plan route (NO TOOLS)**: `route.ts:196-247`
- **AI-SDK route (WITH TOOLS)**: `route.ts:279-335`
- **Path A execution**: `proceed-plan.ts:87-242`
- **Path B execution**: `execute-via-ai-sdk.ts:201-329`
- **File prediction**: `execute-via-ai-sdk.ts:32-91`

### Bugs Fixed by This Change

- **Bug #2/#3**: Files stuck in 'creating' status (code eliminated)
- **Bug #4**: Hypothetical file list mismatch (prediction eliminated)

## Desired End State

After this PR:

1. **All plans have buffered tool calls** - no more text-only plans
2. **Path B is eliminated** - `executeViaAISDK` becomes dead code (can be deleted)
3. **File list is always exact** - derived from buffered tool calls
4. **Single execution path** - all Proceed actions use `proceedPlanAction`

### Verification

```
User says: "Create a nginx helm chart"
    ↓
Intent: isPlan=true, routes to "plan"
    ↓
AI generates with BUFFERED tools:
  - textEditor(create, "Chart.yaml", ...)
  - textEditor(create, "values.yaml", ...)
  - textEditor(create, "templates/deployment.yaml", ...)
    ↓
Plan created with bufferedToolCalls: [3 items]
    ↓
UI shows EXACT file list: Chart.yaml, values.yaml, templates/deployment.yaml
    ↓
User clicks Proceed
    ↓
proceedPlanAction executes buffered calls (Path A)
    ↓
Files created match exactly what was shown
```

## What We're NOT Doing

- **NOT changing intent classification** - `isPlan && !isConversational` still routes to plan
- **NOT changing Path A execution** - `proceedPlanAction` stays the same
- **NOT fixing Bug #5** (malformed str_replace) - separate fix needed
- **NOT fixing Bugs #6/#7** (render intent issues) - separate fix needed
- **NOT fixing Bug #8** (revision number stuck at 0) - separate investigation

## Implementation Approach

The change is minimal - we're essentially merging the plan route's `onFinish` logic with the ai-sdk route's tool handling.

## Phase 1: Create Hybrid Plan Prompt

### Overview
Create a new system prompt that combines planning instructions with tool directives. The AI should emit tool calls while also explaining the plan.

### Changes Required:

#### 1.1 Add New Prompt Constant

**File**: `chartsmith/chartsmith-app/lib/ai/prompts.ts`
**Changes**: Add `CHARTSMITH_PLAN_WITH_TOOLS_PROMPT` after line 143

```typescript
/**
 * PR4.2: Plan generation prompt WITH tool directives
 *
 * This prompt instructs the AI to:
 * 1. Describe the plan in text (for user understanding)
 * 2. Emit tool calls for files to be created/modified (for exact file list)
 *
 * The tool calls are buffered during streaming, not executed.
 * This ensures the file list shown matches exactly what will execute on Proceed.
 */
export const CHARTSMITH_PLAN_WITH_TOOLS_PROMPT = `You are ChartSmith, an expert AI assistant and highly skilled senior software developer specializing in creation, improvement, and maintenance of Helm charts.

## Your Task
When asked to create or modify a Helm chart, you will:
1. Briefly describe your plan (2-3 sentences explaining the approach)
2. Use the textEditor tool to specify each file you will create or modify

## Available Tools
You have access to tools to:
- Get current chart context and file contents
- Create new files using the textEditor tool with the "create" command
- Modify existing files using the textEditor tool with the "str_replace" command
- Look up the latest versions of Helm subcharts and Kubernetes

## CRITICAL Instructions
- MUST use textEditor tool with "create" command for each new file
- MUST use textEditor tool with "str_replace" command for each modification
- Provide COMPLETE file contents - no placeholders or TODOs
- Do NOT narrate your actions ("Let me create...", "Now I'll add...")
- Keep your text explanation brief - the tool calls are the main output

## Code Formatting
- Use 2 spaces for indentation in YAML files
- Ensure YAML and Helm templates are valid and syntactically correct
- Use proper Helm templating expressions ({{ ... }})
- Parameterize values like image tags, resource counts, ports, and labels

## System Constraints
- Focus exclusively on Helm charts and Kubernetes manifests
- Do not assume presence of external services unless explicitly mentioned
- Incorporate information into recent versions of Kubernetes and Helm

## Response Format
- Use only valid Markdown for text responses
- Do not use HTML elements
- Be concise and precise
- NEVER use the word "artifact"
`;
```

#### 1.2 Export the New Prompt

**File**: `chartsmith/chartsmith-app/lib/ai/prompts.ts`
**Changes**: Add to exports (around line 300-313)

```typescript
export default {
  CHARTSMITH_TOOL_SYSTEM_PROMPT,
  CHARTSMITH_PLAN_SYSTEM_PROMPT,
  CHARTSMITH_PLAN_WITH_TOOLS_PROMPT,  // ADD
  CHARTSMITH_CHAT_PROMPT,
  // ... rest of exports
};
```

### Success Criteria:

#### Automated Verification:
- [ ] TypeScript compiles: `cd chartsmith/chartsmith-app && npm run build`
- [ ] Linting passes: `cd chartsmith/chartsmith-app && npm run lint`
- [ ] New prompt is exported and importable

#### Manual Verification:
- [ ] N/A - prompt not yet used

---

## Phase 2: Enable Buffered Tools in Plan Route

### Overview
Modify the plan route to use the new prompt and pass buffered tools. The `onFinish` callback will use buffered tool calls instead of an empty array.

### Changes Required:

#### 2.1 Import New Prompt

**File**: `chartsmith/chartsmith-app/app/api/chat/route.ts`
**Changes**: Update import at line 38-40

```typescript
import {
  getSystemPromptForPersona,
  CHARTSMITH_PLAN_SYSTEM_PROMPT,
  CHARTSMITH_PLAN_WITH_TOOLS_PROMPT,  // ADD
  getPlanOnlyUserMessage,
} from '@/lib/ai/prompts';
```

#### 2.2 Modify Plan Route to Use Tools

**File**: `chartsmith/chartsmith-app/app/api/chat/route.ts`
**Changes**: Replace lines 196-247 (the entire `case "plan":` block)

```typescript
case "plan": {
  // PR4.2: PLAN GENERATION PHASE - WITH BUFFERED TOOLS
  // Tools are enabled but buffered, not executed
  // This ensures file list is exact (from buffered tool calls)
  console.log('[/api/chat] Plan generation phase - WITH BUFFERED TOOLS');

  // Inject the "describe plan only" user message
  // Keeps the instruction to describe the plan, but AI can also emit tool calls
  const planOnlyMessage = getPlanOnlyUserMessage(isInitialPrompt);
  const messagesWithPlanPrompt = [
    ...convertToModelMessages(messages),
    { role: 'user' as const, content: planOnlyMessage },
  ];

  const planResult = streamText({
    model: modelInstance,
    system: CHARTSMITH_PLAN_WITH_TOOLS_PROMPT,  // CHANGED: Use new prompt with tool directives
    messages: messagesWithPlanPrompt,
    tools,  // ADD: Pass buffered tools (created at line 140-146)
    stopWhen: stepCountIs(5),  // ADD: Prevent infinite tool loops
    onFinish: async ({ finishReason, usage, text }) => {
      console.log('[/api/chat] Plan streaming finished:', {
        finishReason,
        usage,
        chatMessageId,
        workspaceId,
        textLength: text?.length ?? 0,
        bufferedToolCallCount: bufferedToolCalls.length,  // ADD: Log tool call count
      });

      // PR4.2: Create plan from buffered tool calls (not empty array)
      // If no tool calls were emitted, still create plan with description as fallback
      if (workspaceId && chatMessageId) {
        try {
          const planId = await createPlanFromToolCalls(
            authHeader,
            workspaceId,
            chatMessageId,
            bufferedToolCalls,  // CHANGED: Use buffered tool calls instead of []
            text  // Still pass description for display
          );
          console.log('[/api/chat] Created plan:', {
            planId,
            hasToolCalls: bufferedToolCalls.length > 0,
            toolCallCount: bufferedToolCalls.length,
          });
        } catch (err) {
          console.error('[/api/chat] Failed to create plan:', err);
          // Plan creation failure is logged but doesn't fail the response
        }
      }
    },
  });

  return planResult.toUIMessageStreamResponse();
}
```

### Success Criteria:

#### Automated Verification:
- [ ] TypeScript compiles: `cd chartsmith/chartsmith-app && npm run build`
- [ ] Linting passes: `cd chartsmith/chartsmith-app && npm run lint`

#### Manual Verification:
- [ ] Create new workspace, say "Create a nginx helm chart"
- [ ] Verify logs show `Plan generation phase - WITH BUFFERED TOOLS`
- [ ] Verify logs show `bufferedToolCallCount: X` where X > 0
- [ ] Verify plan is created with tool calls (not empty array)
- [ ] Verify UI shows exact file list before Proceed

**Implementation Note**: After completing this phase and all automated verification passes, pause here for manual confirmation from the human that the manual testing was successful before proceeding to the next phase.

---

## Phase 3: Update Frontend to Always Use Path A

### Overview
Simplify `PlanChatMessage.tsx` to always use `proceedPlanAction` since all plans now have buffered tool calls. Remove the Path B fallback.

### Changes Required:

#### 3.1 Simplify handleProceed

**File**: `chartsmith/chartsmith-app/components/PlanChatMessage.tsx`
**Changes**: Simplify lines 155-195

```typescript
const handleProceed = async () => {
  if (!session || !plan) return;

  const wsId = workspaceId || plan.workspaceId;
  if (!wsId) return;

  setIsProceeding(true);
  try {
    const revisionNumber = workspaceToUse?.currentRevisionNumber ?? 0;

    // PR4.2: All plans now have buffered tool calls
    // Path B (executeViaAISDK) is eliminated
    if (plan.bufferedToolCalls && plan.bufferedToolCalls.length > 0) {
      // Path A: Execute buffered tool calls directly
      await proceedPlanAction(session, plan.id, wsId, revisionNumber);
    } else if (plan.description) {
      // Fallback: Text-only plan without tool calls
      // This shouldn't happen after PR4.2, but keep as safety net
      console.warn('[PlanChatMessage] Plan has no buffered tool calls, falling back to legacy path');
      // For now, still call executeViaAISDK as fallback
      // TODO: Remove this fallback after PR4.2 is verified stable
      await executeViaAISDK({
        session,
        planId: plan.id,
        workspaceId: wsId,
        revisionNumber,
        planDescription: plan.description,
      });
    } else {
      // Path C: Legacy Go worker fallback (should be rare)
      console.warn('[PlanChatMessage] Using legacy Go worker path');
      const updatedWorkspace = await createRevisionAction(session, plan.id);
      if (updatedWorkspace && setWorkspace) {
        setWorkspace(updatedWorkspace);
      }
    }
    onProceed?.();
  } catch (error) {
    console.error('[PlanChatMessage] Proceed failed:', error);
  } finally {
    setIsProceeding(false);
  }
};
```

**Note**: We keep the fallbacks with warnings rather than removing them entirely. This allows us to monitor for any edge cases before fully removing Path B in a future cleanup.

### Success Criteria:

#### Automated Verification:
- [ ] TypeScript compiles: `cd chartsmith/chartsmith-app && npm run build`
- [ ] Linting passes: `cd chartsmith/chartsmith-app && npm run lint`

#### Manual Verification:
- [ ] Create workspace, generate plan, click Proceed
- [ ] Verify no console warnings about "no buffered tool calls"
- [ ] Verify files are created successfully
- [ ] Verify file status transitions: pending → creating → created

**Implementation Note**: After completing this phase and all automated verification passes, pause here for manual confirmation from the human that the manual testing was successful before proceeding to the next phase.

---

## Phase 4: Cleanup (Optional - Can Be Deferred)

### Overview
Remove dead code after PR4.2 is verified stable in production.

### Changes Required:

#### 4.1 Delete Path B Execution File

**File**: `chartsmith/chartsmith-app/lib/workspace/actions/execute-via-ai-sdk.ts`
**Changes**: Delete entire file (after verification period)

#### 4.2 Remove Import from PlanChatMessage

**File**: `chartsmith/chartsmith-app/components/PlanChatMessage.tsx`
**Changes**: Remove import and fallback code

```diff
- import { executeViaAISDK } from "@/lib/workspace/actions/execute-via-ai-sdk";
```

#### 4.3 Delete Old Plan Prompt

**File**: `chartsmith/chartsmith-app/lib/ai/prompts.ts`
**Changes**: Remove `CHARTSMITH_PLAN_SYSTEM_PROMPT` if no longer used

### Success Criteria:

#### Automated Verification:
- [ ] TypeScript compiles with no unused import warnings
- [ ] No references to `executeViaAISDK` remain

#### Manual Verification:
- [ ] Full regression test of plan/execute flow

---

## Testing Strategy

### Unit Tests:
- N/A - this is primarily integration behavior

### Integration Tests:
- Test plan generation with various prompts
- Verify buffered tool calls are populated
- Verify Path A execution works correctly

### Manual Testing Steps:

1. **New chart creation**:
   - Create new workspace
   - Say "Create a basic nginx helm chart"
   - Verify plan shows file list (Chart.yaml, values.yaml, templates/...)
   - Click Proceed
   - Verify all files created with correct content

2. **Chart modification**:
   - With existing chart, say "Add a ConfigMap for nginx configuration"
   - Verify plan shows file to be created/modified
   - Click Proceed
   - Verify file changes applied correctly

3. **Edge cases**:
   - Very simple request ("Add a comment to Chart.yaml")
   - Complex request ("Add ingress, service, configmap, and HPA")
   - Verify file lists are accurate in all cases

4. **Regression check**:
   - Verify existing Path A plans (from ai-sdk route) still work
   - Verify no duplicate messages or other bugs introduced

## Performance Considerations

- **Reduced LLM calls**: Path B required 2 LLM calls (prediction + execution). Now all plans use Path A which requires 0 LLM calls on Proceed.
- **Faster Proceed**: Executing buffered tool calls is faster than calling LLM again.

## Migration Notes

- No database migrations required
- No breaking changes to API contracts
- Backwards compatible - existing plans with buffered tool calls continue to work

## References

- Research document: `thoughts/shared/research/2025-12-07-plan-execute-architecture.md`
- Bug tracking: `thoughts/shared/bugs/2025-12-07-plan-execute-bugs.md`
- PR4.1 (separate): `docs/PR4.1_VALIDATION_UI_INTEGRATION.md`
