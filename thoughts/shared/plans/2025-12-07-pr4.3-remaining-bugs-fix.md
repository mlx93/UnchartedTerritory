# PR4.3: Remaining Bug Fixes (Not Covered by PR4.1/PR4.2)

## Overview

This plan addresses 5 bugs that are NOT fixed by PR4.1 (Validation UI Integration) or PR4.2 (Unified Plan/Execute Architecture):

| Bug | Severity | Issue | Root Cause |
|-----|----------|-------|------------|
| #1 | Medium | Duplicate message after page refresh | `hasAutoSentRef` resets on remount |
| #5 | High | str_replace missing oldStr parameter | No validation before buffering |
| #6 | Low | Render intent creates plans unexpectedly | textEditor available for render intent |
| #7 | High | Validate triggers circular tool loops | textEditor + auto-fix behavior |
| #8 | Medium | Revision number stuck at 0 | Workspace atom not updated after execution |

## Current State Analysis

### Bug Relationships

**Bugs #5, #6, #7 share a common root cause**: Render intent routes to `ai-sdk` path with full tools (including `textEditor`). This enables:
- AI to buffer file modifications → creates plans (Bug #6)
- AI to attempt auto-fixing validation errors → circular loop (Bug #7)
- Malformed tool calls generated during loops → missing oldStr (Bug #5)

**Bugs #1 and #8 are independent** and require separate fixes.

### Key Code Locations

**Bug #1 (Duplicate message)**:
- `chartsmith/chartsmith-app/hooks/useAISDKChatAdapter.ts:112` - `hasAutoSentRef` initialization
- `chartsmith/chartsmith-app/hooks/useAISDKChatAdapter.ts:164-194` - Auto-send effect

**Bugs #5, #6, #7 (Render intent issues)**:
- `chartsmith/chartsmith-app/app/api/chat/route.ts:140-146` - Tool creation (all intents get same tools)
- `chartsmith/chartsmith-app/app/api/chat/route.ts:256-260` - Render case (falls through to ai-sdk)
- `chartsmith/chartsmith-app/app/api/chat/route.ts:287-328` - Plan creation (no render check)
- `chartsmith/chartsmith-app/lib/ai/tools/bufferedTools.ts:124-137` - No validation before buffering

**Bug #8 (Revision stuck at 0)**:
- `chartsmith/chartsmith-app/components/PlanChatMessage.tsx:163` - Reads stale `currentRevisionNumber`
- `chartsmith/chartsmith-app/lib/workspace/actions/proceed-plan.ts:87-242` - No workspace atom update
- `chartsmith/chartsmith-app/lib/workspace/actions/execute-via-ai-sdk.ts:201-329` - No workspace atom update

## Desired End State

After this PR:

1. **Bug #1 Fixed**: Page refresh does not trigger duplicate auto-send for messages that already have responses
2. **Bug #5 Fixed**: str_replace tool calls are validated for required `oldStr` parameter before buffering
3. **Bug #6 Fixed**: Render intent does NOT create plans (validation is read-only)
4. **Bug #7 Fixed**: Render intent uses read-only tools (no `textEditor`), preventing auto-fix loops
5. **Bug #8 Fixed**: Workspace atom is updated after plan execution, enabling correct revision tracking

### Verification

```
User says: "validate my chart"
    ↓
Intent: isRender=true, routes to "render"
    ↓
Read-only tools used: validateChart, getChartContext, etc. (NO textEditor)
    ↓
AI calls validateChart → reports results
    ↓
NO plan created (render intent skips plan creation)
    ↓
User sees validation results without auto-fix attempts
```

## What We're NOT Doing

- **NOT changing PR4.2's buffered plan architecture** - that addresses Bugs #2/#3/#4
- **NOT modifying intent classification** - the `isRender` detection is correct
- **NOT changing the validation tool itself** - it works correctly

## Implementation Approach

We'll address these bugs in 3 phases:
1. **Phase 1 (High Priority)**: Intent Routing Fixes - Bugs #5, #6, #7
2. **Phase 2 (Medium Priority)**: Revision Number Fix - Bug #8
3. **Phase 3 (Medium Priority)**: Duplicate Message Fix - Bug #1

This ordering prioritizes:
- High-severity bugs (#5, #7) first
- Related bugs together (intent routing cluster)
- Independent bugs separately

---

## Phase 1: Intent Routing Fixes (Bugs #5, #6, #7)

### Overview
Fix the render intent to use read-only tools and bypass plan creation. This single change addresses all three related bugs.

### Changes Required:

#### 1.1 Create Read-Only Tools Function

**File**: `chartsmith/chartsmith-app/lib/ai/tools/index.ts`
**Changes**: Add new function after `createTools` (around line 77)

```typescript
/**
 * Create read-only AI SDK tools for validation/render intents.
 *
 * These tools allow the AI to inspect the chart but NOT modify it.
 * Used for render/validation intents where the AI should only report
 * findings, not attempt automatic fixes.
 */
export function createReadOnlyTools(
  authHeader: string | undefined,
  workspaceId: string,
  revisionNumber: number
) {
  return {
    // Read-only tools - NO textEditor
    getChartContext: createGetChartContextTool(workspaceId, revisionNumber, authHeader || ''),
    validateChart: createValidateChartTool(authHeader, workspaceId, revisionNumber),
    latestSubchartVersion: createLatestSubchartVersionTool(authHeader),
    latestKubernetesVersion: createLatestKubernetesVersionTool(authHeader),
  };
}
```

#### 1.2 Add Validation Prompt for Render Intent

**File**: `chartsmith/chartsmith-app/lib/ai/prompts.ts`
**Changes**: Add new prompt constant after `CHARTSMITH_EXECUTION_SYSTEM_PROMPT` (around line 285)

```typescript
/**
 * PR4.3: Validation/Render persona prompt - read-only inspection
 *
 * Used when the user asks to validate, test, or render their chart.
 * Emphasizes reporting results without making changes.
 */
export const CHARTSMITH_VALIDATION_PROMPT = `You are ChartSmith, an expert AI assistant specializing in Helm charts.

## Validation Mode

The user wants you to inspect and report on their chart. You are in READ-ONLY mode.

## Available Tools
- validateChart: Runs helm lint, helm template, and kube-score
- getChartContext: Gets current chart file contents
- latestSubchartVersion: Looks up latest versions of subcharts
- latestKubernetesVersion: Looks up latest Kubernetes version

## Instructions

When validating a chart:
1. Call validateChart tool to check for issues
2. Report ALL findings clearly to the user
3. Organize issues by severity (errors, warnings, info)
4. Explain what each issue means and why it matters

## CRITICAL

- DO NOT attempt to fix issues automatically
- DO NOT suggest using textEditor or any write operations
- Let the USER decide what to fix and when
- You are here to REPORT, not to MODIFY

## Response Format

Provide a clear summary including:
- What passed validation (if any)
- What issues were found with severity levels
- Recommended next steps for the user to consider
`;
```

#### 1.3 Track Render Intent and Use Read-Only Tools

**File**: `chartsmith/chartsmith-app/app/api/chat/route.ts`
**Changes**: Multiple edits

**1.3a: Add import for new function and prompt (around line 38-42)**

```typescript
import {
  getSystemPromptForPersona,
  CHARTSMITH_PLAN_SYSTEM_PROMPT,
  CHARTSMITH_VALIDATION_PROMPT,  // ADD
  getPlanOnlyUserMessage,
} from '@/lib/ai/prompts';
```

```typescript
import {
  createTools,
  createBufferedTools,
  createReadOnlyTools,  // ADD
} from "@/lib/ai/tools";
```

**1.3b: Add render intent tracking flag (around line 136)**

```typescript
// PR3.4: Track if original intent was a plan request (even if routed to ai-sdk)
// This allows creating text-only plans when model doesn't emit tool calls
let wasIntentPlan = false;

// PR4.3: Track if this was a render intent for read-only tools and skip plan creation
let wasIntentRender = false;
```

**1.3c: Set render flag after intent classification (around line 183)**

```typescript
// PR3.4: Track if this was a plan intent for fallback text-only plan creation
wasIntentPlan = intent.isPlan;

// PR4.3: Track if this was a render intent
wasIntentRender = intent.isRender;
```

**1.3d: Update tool creation to use read-only tools for render intent (lines 140-152)**

Replace:
```typescript
const tools = workspaceId
  ? (chatMessageId
      ? createBufferedTools(authHeader, workspaceId, revisionNumber ?? 0, (toolCall) => {
          bufferedToolCalls.push(toolCall);
        }, chatMessageId)
      : createTools(authHeader, workspaceId, revisionNumber ?? 0, chatMessageId))
  : undefined;
```

With:
```typescript
// PR4.3: Tool creation is deferred until after intent classification
// We need to know if this is a render intent before selecting tools
let tools: ReturnType<typeof createTools> | ReturnType<typeof createReadOnlyTools> | undefined;

// Function to create appropriate tools based on intent
const createAppropriateTools = () => {
  if (!workspaceId) return undefined;

  // PR4.3: Render intent uses read-only tools (no textEditor)
  if (wasIntentRender) {
    console.log('[/api/chat] Using read-only tools for render intent');
    return createReadOnlyTools(authHeader, workspaceId, revisionNumber ?? 0);
  }

  // Plan/execute intents use buffered or regular tools
  return chatMessageId
    ? createBufferedTools(authHeader, workspaceId, revisionNumber ?? 0, (toolCall) => {
        bufferedToolCalls.push(toolCall);
      }, chatMessageId)
    : createTools(authHeader, workspaceId, revisionNumber ?? 0, chatMessageId);
};
```

**1.3e: Call tool creation after intent is classified (around line 185)**

After setting `wasIntentRender = intent.isRender;`, add:
```typescript
// PR4.3: Create tools now that we know the intent type
tools = createAppropriateTools();
```

**1.3f: Update system prompt selection for render intent (around line 158)**

Replace:
```typescript
const systemPrompt = getSystemPromptForPersona(persona);
```

With:
```typescript
// PR4.3: System prompt selection is deferred until after intent classification
let systemPrompt: string;
```

Then after intent classification (around line 185), add:
```typescript
// PR4.3: Use validation prompt for render intent
systemPrompt = wasIntentRender
  ? CHARTSMITH_VALIDATION_PROMPT
  : getSystemPromptForPersona(persona);
```

**1.3g: Skip plan creation for render intent (around line 297)**

Replace:
```typescript
if (bufferedToolCalls.length > 0) {
```

With:
```typescript
// PR4.3: Skip plan creation for render intent (validation is read-only)
if (bufferedToolCalls.length > 0 && !wasIntentRender) {
```

Also update the text-only plan fallback (around line 312):
```typescript
} else if (wasIntentPlan && workspaceId && chatMessageId) {
```

To:
```typescript
} else if (wasIntentPlan && !wasIntentRender && workspaceId && chatMessageId) {
```

#### 1.4 Add Validation Before Buffering str_replace Calls

**File**: `chartsmith/chartsmith-app/lib/ai/tools/bufferedTools.ts`
**Changes**: Add validation before buffering (around line 120)

Replace the execute function for textEditor (lines 95-138):
```typescript
execute: async (params, { toolCallId }) => {
  console.log('[bufferedTools:textEditor] execute called:', { toolCallId, command: params.command, path: params.path });

  // VIEW: Execute immediately (read-only)
  if (params.command === 'view') {
    const result = await callGoEndpoint<TextEditorResponse>(
      '/api/tools/editor',
      {
        command: params.command,
        workspaceId,
        path: params.path,
        revisionNumber,
      },
      authHeader,
    );
    return result;
  }

  // PR4.3: Validate str_replace has required parameters before buffering
  if (params.command === 'str_replace') {
    if (!params.oldStr) {
      console.error('[bufferedTools:textEditor] str_replace missing oldStr:', { toolCallId, path: params.path });
      return {
        success: false,
        message: 'str_replace requires oldStr parameter - you must specify the exact text to find and replace',
      };
    }
    if (params.newStr === undefined) {
      console.error('[bufferedTools:textEditor] str_replace missing newStr:', { toolCallId, path: params.path });
      return {
        success: false,
        message: 'str_replace requires newStr parameter - you must specify the replacement text',
      };
    }
  }

  // CREATE/STR_REPLACE: Buffer for plan workflow
  onToolCall({
    id: toolCallId,
    toolName: "textEditor",
    args: params,
    timestamp: Date.now(),
  });

  return {
    success: true,
    message: `File change will be applied after review: ${params.command} ${params.path}`,
    buffered: true,
  };
},
```

### Success Criteria:

#### Automated Verification:
- [ ] TypeScript compiles: `cd chartsmith/chartsmith-app && npm run build`
- [ ] Linting passes: `cd chartsmith/chartsmith-app && npm run lint`
- [ ] No references to textEditor in read-only tools

#### Manual Verification:
- [ ] Say "validate my chart" → AI uses validateChart tool only
- [ ] AI reports errors without attempting to fix them
- [ ] No plan is created for validation requests
- [ ] str_replace without oldStr returns error message, not buffered
- [ ] Normal plan creation still works for "create a chart" requests

**Implementation Note**: After completing this phase, verify all manual tests pass before proceeding.

---

## Phase 2: Revision Number Fix (Bug #8)

### Overview
Update the workspace atom after plan execution so subsequent edits use the correct revision number.

### Changes Required:

#### 2.1 Update proceedPlanAction to Return Workspace

**File**: `chartsmith/chartsmith-app/lib/workspace/actions/proceed-plan.ts`
**Changes**:

**2.1a: Update return type (around line 87)**

```typescript
export async function proceedPlanAction(
  session: Session,
  planId: string,
  workspaceId: string,
  revisionNumber: number
): Promise<Workspace | null> {  // CHANGED from Promise<void>
```

**2.1b: Add import for getWorkspace (at top)**

```typescript
import { getWorkspace } from '../workspace';
```

**2.1c: Return updated workspace at end (before final closing brace, around line 240)**

```typescript
  // PR4.3: Fetch and return updated workspace for atom update
  const updatedWorkspace = await getWorkspace(workspaceId);
  return updatedWorkspace;
```

#### 2.2 Update executeViaAISDK to Return Workspace

**File**: `chartsmith/chartsmith-app/lib/workspace/actions/execute-via-ai-sdk.ts`
**Changes**:

**2.2a: Update return type (around line 201)**

```typescript
export async function executeViaAISDK({
  session,
  planId,
  workspaceId,
  revisionNumber,
  planDescription,
  provider,
}: ExecuteViaAISDKParams): Promise<Workspace | null> {  // CHANGED from Promise<void>
```

**2.2b: Add import for getWorkspace (at top)**

```typescript
import { getWorkspace } from '../workspace';
```

**2.2c: Return updated workspace at end (after publishPlanUpdate, around line 325)**

```typescript
  await publishPlanUpdate(workspaceId, planId);

  // PR4.3: Fetch and return updated workspace for atom update
  const updatedWorkspace = await getWorkspace(workspaceId);
  return updatedWorkspace;
}
```

#### 2.3 Update PlanChatMessage to Update Workspace Atom

**File**: `chartsmith/chartsmith-app/components/PlanChatMessage.tsx`
**Changes**: Update handleProceed (around lines 165-180)

Replace:
```typescript
if (plan.bufferedToolCalls && plan.bufferedToolCalls.length > 0) {
  // Path A: Execute buffered tool calls directly via server action
  await proceedPlanAction(session, plan.id, wsId, revisionNumber);
} else if (plan.description) {
  // Path B: Text-only plan - need LLM to generate and execute tool calls
  await executeViaAISDK({
    session,
    planId: plan.id,
    workspaceId: wsId,
    revisionNumber,
    planDescription: plan.description,
  });
}
```

With:
```typescript
if (plan.bufferedToolCalls && plan.bufferedToolCalls.length > 0) {
  // Path A: Execute buffered tool calls directly via server action
  const updatedWorkspace = await proceedPlanAction(session, plan.id, wsId, revisionNumber);
  // PR4.3: Update workspace atom with new revision number
  if (updatedWorkspace && setWorkspace) {
    setWorkspace(updatedWorkspace);
  }
} else if (plan.description) {
  // Path B: Text-only plan - need LLM to generate and execute tool calls
  const updatedWorkspace = await executeViaAISDK({
    session,
    planId: plan.id,
    workspaceId: wsId,
    revisionNumber,
    planDescription: plan.description,
  });
  // PR4.3: Update workspace atom with new revision number
  if (updatedWorkspace && setWorkspace) {
    setWorkspace(updatedWorkspace);
  }
}
```

### Success Criteria:

#### Automated Verification:
- [ ] TypeScript compiles: `cd chartsmith/chartsmith-app && npm run build`
- [ ] Linting passes: `cd chartsmith/chartsmith-app && npm run lint`

#### Manual Verification:
- [ ] Create first chart → revisionNumber increments from 0 to 1
- [ ] Create second chart → revisionNumber increments from 1 to 2
- [ ] Check Go backend logs show correct revisionNumber in requests

**Implementation Note**: After completing this phase, verify revision numbers increment correctly.

---

## Phase 3: Duplicate Message Fix (Bug #1)

### Overview
Prevent duplicate auto-send after page refresh by checking if the message has already been processed.

### Changes Required:

#### 3.1 Add Message ID Tracking and Better Conditions

**File**: `chartsmith/chartsmith-app/hooks/useAISDKChatAdapter.ts`
**Changes**:

**3.1a: Add message ID tracking ref (after line 112)**

```typescript
// Track if we've auto-sent the initial message (prevents duplicates)
const hasAutoSentRef = useRef(false);

// PR4.3: Track which message IDs we've auto-sent in this session (defense-in-depth)
const autoSentMessageIdsRef = useRef<Set<string>>(new Set());
```

**3.1b: Update auto-send logic (lines 164-194)**

Replace the entire useEffect:
```typescript
// Auto-send: If there's an initial message without a response, send it to AI SDK
// This handles the flow from landing page where createWorkspaceFromPromptAction
// persists the user message to DB, then we need to get the AI response
useEffect(() => {
  // Use ref check FIRST to prevent any possibility of double-send in same session
  if (hasAutoSentRef.current) return;

  // Find the last user message that has no response
  const lastMessage = jotaiMessages.length > 0
    ? jotaiMessages[jotaiMessages.length - 1]
    : null;

  // PR4.3: Check if we've already auto-sent this specific message ID (defense-in-depth)
  if (lastMessage && autoSentMessageIdsRef.current.has(lastMessage.id)) {
    console.log('[useAISDKChatAdapter] Skipping auto-send - already sent message:', lastMessage.id);
    return;
  }

  // Only auto-send if there's a user message without a response
  // PR4.3: Also check isIntentComplete to prevent re-sending after page refresh
  // If intent is complete, the message was already processed in a previous session
  const needsResponse = lastMessage
    && lastMessage.prompt
    && !lastMessage.response
    && lastMessage.isIntentComplete === false;  // Only send if never processed

  if (needsResponse && aiMessages.length === 0 && workspaceId) {
    // Mark as sent BEFORE calling sendMessage to prevent race conditions
    hasAutoSentRef.current = true;
    autoSentMessageIdsRef.current.add(lastMessage.id);
    console.log('[useAISDKChatAdapter] Auto-sending initial message to AI:', lastMessage.prompt);

    // Set the current message ID for persistence tracking
    setCurrentChatMessageId(lastMessage.id);

    // Send to AI SDK with chatMessageId for plan creation
    aiSendMessage(
      { text: lastMessage.prompt },
      { body: getChatBody(lastMessage.id) }
    );
  }
// eslint-disable-next-line react-hooks/exhaustive-deps
}, [jotaiMessages, aiMessages.length, workspaceId]);
```

#### 3.2 Update Initial Message Creation

**File**: `chartsmith/chartsmith-app/lib/workspace/actions/create-ai-sdk-chat-message.ts`
**Changes**: Set isIntentComplete to false initially (around line 83)

Find:
```typescript
true,   // is_intent_complete
```

Replace with:
```typescript
false,  // is_intent_complete - will be set true after AI responds
```

### Success Criteria:

#### Automated Verification:
- [ ] TypeScript compiles: `cd chartsmith/chartsmith-app && npm run build`
- [ ] Linting passes: `cd chartsmith/chartsmith-app && npm run lint`

#### Manual Verification:
- [ ] Create workspace from landing page → message sent once
- [ ] Refresh page immediately after response starts → no duplicate message
- [ ] Refresh page after response completes → no duplicate message
- [ ] Check console logs for "Skipping auto-send" when appropriate

**Implementation Note**: Test thoroughly with various refresh timings.

---

## Testing Strategy

### Unit Tests:
- N/A - these are primarily integration behaviors

### Integration Tests:
- Test render intent uses read-only tools
- Test str_replace validation rejects missing oldStr
- Test plan creation is skipped for render intent
- Test workspace atom updates after plan execution
- Test auto-send prevents duplicates

### Manual Testing Steps:

1. **Bug #5/#6/#7 (Render intent)**:
   - Create workspace with chart
   - Say "validate my chart"
   - Verify AI calls validateChart and reports results
   - Verify NO textEditor calls appear in logs
   - Verify NO plan is created
   - Verify no circular tool call loop

2. **Bug #5 (str_replace validation)**:
   - Attempt to buffer a str_replace without oldStr (via direct tool call or prompt engineering)
   - Verify error message is returned
   - Verify malformed call is NOT buffered

3. **Bug #8 (Revision number)**:
   - Create first chart → check Go logs for revisionNumber=1
   - Modify chart → check Go logs for revisionNumber=2
   - Create another file → check Go logs for revisionNumber=3

4. **Bug #1 (Duplicate message)**:
   - Create workspace from landing page
   - Immediately refresh while streaming
   - Verify only one response appears
   - Refresh after response completes
   - Verify no duplicate messages appear

## Performance Considerations

- Read-only tools for render intent reduce unnecessary AI computation (no file modification attempts)
- Skipping plan creation for render intent reduces database writes
- Workspace atom update after execution is a single additional DB read

## Migration Notes

- No database migrations required
- No breaking changes to API contracts
- Backwards compatible - existing plans continue to work

## References

- Bug tracking: `thoughts/shared/bugs/2025-12-07-plan-execute-bugs.md`
- PR4.2 plan: `thoughts/shared/plans/2025-12-07-pr4.2-unified-plan-execute.md`
- Route handler: `chartsmith/chartsmith-app/app/api/chat/route.ts`
- Tools: `chartsmith/chartsmith-app/lib/ai/tools/index.ts`
- Buffered tools: `chartsmith/chartsmith-app/lib/ai/tools/bufferedTools.ts`
