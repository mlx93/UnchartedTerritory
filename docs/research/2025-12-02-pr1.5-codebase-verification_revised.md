---
date: 2025-12-02T22:02:46Z
researcher: Claude Code
git_commit: e615830f7b0b60ecb817d762b9b4e4186f855d85
branch: main
repository: chartsmith
topic: "PR1.5 Codebase Verification - Vercel AI SDK Migration"
tags: [research, codebase, pr1.5, ai-sdk, migration, go-handlers]
status: complete
last_updated: 2025-12-02
last_updated_by: Claude Code
---

# Research: PR1.5 Codebase Verification for Vercel AI SDK Migration

**Date**: 2025-12-02T22:02:46Z  
**Researcher**: Claude Code  
**Git Commit**: e615830f7b0b60ecb817d762b9b4e4186f855d85  
**Branch**: main  
**Repository**: chartsmith

## Research Question

Verify assumptions in PR1.5_PLAN.md and PR1.5_HIGH_LEVEL_SUMMARY_REVISED.md before implementing the Vercel AI SDK migration:
1. Confirm exact function names, signatures, and locations for workspace/revision/file operations
2. Locate existing tool implementations to port
3. Identify service startup patterns for HTTP server integration
4. Find authentication/authorization patterns
5. Flag architectural surprises

---

## Executive Summary

**CRITICAL FINDINGS**: The PRD makes several incorrect assumptions about the Go codebase:

| PRD Assumption | Actual Implementation | Impact |
|----------------|----------------------|--------|
| Go has CreateWorkspace() function | Workspace creation is **TypeScript only** | HIGH |
| workspace.Notify() exists | Use persistence.EnqueueWork() instead | MEDIUM |
| workspace.LoadByID() exists | Use workspace.GetWorkspace() instead | LOW |
| revisions.GetLatest() exists | No such function; use workspace.CurrentRevision field | MEDIUM |
| Go has HTTP server infrastructure | **NO HTTP infrastructure exists** in Go | HIGH |
| Middleware pattern for auth | **NO middleware** - inline auth in each route | MEDIUM |

---

## Detailed Findings

### 1. Workspace Creation Functions

**PRD Reference**: PR1.5_PLAN.md lines 329-331

**PRD Assumption**:
- CreateWorkspace(ctx, userID, name)
- InitializeWorkspaceFiles(workspaceID, type, opts)
- CreateInitialRevision(workspaceID, files)

**Actual Implementation**: CONTRADICTS PRD

These functions DO NOT EXIST in Go. Workspace creation is TypeScript-only.

**Actual Location**: chartsmith-app/lib/workspace/workspace.ts:12-139

```typescript
export async function createWorkspace(
  createdType: string,
  userId: string,
  createChartMessageParams: CreateChatMessageParams,
  baseChart?: Chart,
  looseFiles?: WorkspaceFile[]
): Promise<Workspace>
```

**Go Functions That Exist** (different purposes):
- workspace.CreateRevision() - pkg/workspace/revision.go:47-155 (subsequent revisions only)
- workspace.CreateChart() - pkg/workspace/chart.go:15-36 (for conversions)
- workspace.AddFileToChart() - pkg/workspace/chart.go:38-54 (conversion workflow)

---

### 2. Notification and Loading Functions

**PRD Reference**: PR1.5_PLAN.md lines 332-335

**PRD Assumption**:
- workspace.Notify(ctx, workspaceID, "chart_created")
- workspace.LoadByID(workspaceID)
- revisions.GetLatest(workspaceID)

**Actual Implementation**: CONTRADICTS PRD

| PRD Function | Actual Function | Location |
|--------------|-----------------|----------|
| workspace.Notify() | persistence.EnqueueWork() | pkg/persistence/queue.go:10-30 |
| workspace.LoadByID() | workspace.GetWorkspace() | pkg/workspace/workspace.go:63-171 |
| revisions.GetLatest() | workspace.CurrentRevision (field) | pkg/workspace/workspace.go:86 |

**EnqueueWork Signature**:
```go
func EnqueueWork(ctx context.Context, channel string, payload interface{}) error
```

**GetWorkspace Signature**:
```go
func GetWorkspace(ctx context.Context, id string) (*types.Workspace, error)
```

**GetRevision Signature** (if full revision object needed):
```go
func GetRevision(ctx context.Context, workspaceID string, revisionNumber int) (*types.Revision, error)
```

---

### 3. File Operation Functions

**PRD Reference**: PR1.5_PLAN.md lines 335-336

**PRD Assumption**:
- workspaceFiles.List(revision.ID)
- files.ApplyPatch(...)

**Actual Implementation**: PARTIALLY CORRECT

| PRD Function | Actual Function | Location |
|--------------|-----------------|----------|
| workspaceFiles.List() | workspace.ListFiles() | pkg/workspace/file.go:65-97 |
| files.ApplyPatch() | diff.ApplyPatch() | pkg/diff/apply.go:29-86 |

**ListFiles Signature**:
```go
func ListFiles(ctx context.Context, workspaceID string, revisionNumber int, chartID string) ([]types.File, error)
```

**ApplyPatch Signature**:
```go
func ApplyPatch(content string, patchText string) (string, error)
```

---

### 4. latest_subchart_version Tool

**PRD Reference**: PR1.5_PLAN.md lines 92-111

**Actual Implementation**: VALIDATES PRD

**Tool Definition**: pkg/llm/conversational.go:100-113
**Core Logic**: pkg/recommendations/subchart.go:21-40

```go
func GetLatestSubchartVersion(chartName string) (string, error)
```

**Implementation**:
1. Check hardcoded override map
2. Special handling for "replicated" charts via GitHub API
3. Query ArtifactHub API: https://artifacthub.io/api/v1/packages/search
4. Return first result's version or ErrNoArtifactHubPackage

**For HTTP Handler**: Reuse recommendations.GetLatestSubchartVersion() directly.

---

### 5. latest_kubernetes_version Tool

**PRD Reference**: PR1.5_PLAN.md lines 113-131

**Actual Implementation**: PARTIALLY CONTRADICTS PRD

**Tool Location**: pkg/llm/conversational.go:175-191

**CRITICAL**: Returns HARDCODED values, not API data.

```go
switch input.SemverField {
case "major":
    response = "1"
case "minor":
    response = "1.32"
case "patch":
    response = "1.32.1"
}
```

**PRD Differences**:
- PRD says channel (stable/latest/all), actual is semver_field (major/minor/patch)
- PRD implies API lookup, actual is hardcoded strings
- Schema bug: required field is "semver_description" but property is "semver_field"

---

### 6. text_editor Tool

**PRD Reference**: PR1.5_PLAN.md lines 167-194

**Actual Implementation**: VALIDATES PRD (partially)

**Location**: pkg/llm/execute-action.go:510-654 (NOT pkg/agent/tools/)

**Supported Commands**: view, str_replace, create (NO "insert" command exists)

**Key Functions for HTTP Handler**:

| Function | Location | Purpose |
|----------|----------|---------|
| PerformStringReplacement() | execute-action.go:238-317 | Exact + fuzzy string replacement |
| findBestMatchRegion() | execute-action.go:319-435 | Fuzzy match algorithm |
| workspace.SetFileContentPending() | file.go:107-165 | Update file content |
| workspace.ListFiles() | file.go:65-97 | Get files for chart |
| workspace.AddFileToChart() | chart.go:38-54 | Create new file |

---

### 7. Service Startup Pattern

**PRD Reference**: PR1.5_PLAN.md lines 56-57

**Actual Implementation**: VALIDATES PRD

**Entry Point**: cmd/run.go:43-56

**Recommended HTTP Server Integration** (after line 72):

```go
listener.StartHeartbeat(ctx)

// ADD HERE:
go api.StartHTTPServer(ctx, "8080")

if err := listener.StartListeners(ctx); err != nil { ... }
```

---

### 8. Authentication Patterns

**PRD Reference**: PR1.5_PLAN.md line 322-323

**Actual Implementation**: NO MIDDLEWARE EXISTS

Authentication is inline at start of each route handler.

**Extension Token Validation** (lib/auth/extension-token.ts:23-35):
```typescript
export async function userIdFromExtensionToken(token: string): Promise<string | null> {
    const query = `SELECT user_id FROM extension_token WHERE token = $1`
    // ...
}
```

**Workspace Ownership** (pkg/workspace/workspace.go:14-37):
```go
func ListUserIDsForWorkspace(ctx context.Context, workspaceID string) ([]string, error)
```

**Required Go Implementation Pattern**:
```go
func validateRequest(r *http.Request) (userId string, err error) {
    authHeader := r.Header.Get("Authorization")
    if authHeader == "" {
        return "", errors.New("unauthorized")
    }
    token := strings.TrimPrefix(authHeader, "Bearer ")
    userId, err = validateExtensionToken(ctx, token)
    return userId, err
}
```

---

### 9. HTTP Infrastructure

**PRD Reference**: PR1.5_PLAN.md lines 47-56

**Actual Implementation**: VALIDATES PRD (no existing infrastructure)

**Finding**: Go codebase has ZERO HTTP server infrastructure.
- No HTTP handlers
- No routes defined
- gorilla/mux is indirect dependency only (from K8s libs)
- All REST APIs are in Next.js

**Must Create From Scratch**:
- pkg/api/server.go
- pkg/api/handlers/*.go
- pkg/api/errors.go

---

## Correct Function Reference Table

| PRD Reference | Actual Function | Location |
|---------------|-----------------|----------|
| CreateWorkspace() | N/A (TypeScript only) | workspace.ts:12 |
| workspace.Notify() | persistence.EnqueueWork() | queue.go:10 |
| workspace.LoadByID() | workspace.GetWorkspace() | workspace.go:63 |
| revisions.GetLatest() | workspace.CurrentRevision | workspace.go:86 |
| workspaceFiles.List() | workspace.ListFiles() | file.go:65 |
| files.ApplyPatch() | diff.ApplyPatch() | apply.go:29 |

---

## Architectural Surprises

1. **Workspace Creation is TypeScript-Only** - Go only handles subsequent operations
2. **Dual Content Model** - Files have content and content_pending fields
3. **No HTTP Server in Go** - Pure worker system via PostgreSQL LISTEN/NOTIFY
4. **Extension Token Auth** - Simple DB lookup, not JWT; tokens don't expire
5. **Hardcoded K8s Versions** - Tool returns static strings
6. **No "insert" Command** - text_editor only has view, str_replace, create

---

## Open Questions

1. Should Go implement workspace creation SQL or call TypeScript endpoint?
2. Should K8s version handler return hardcoded values or implement API lookup?
3. Should "insert" command be added to text_editor or removed from PRD?

---

*End of Research Document*
