# PR1.6 PRD Gaps Analysis

**Date**: December 4, 2025
**Purpose**: Document gaps between original research findings and PR1.6 PRDs for implementation agents
**Related PRDs**: `PRDs/PR1.6_Tech_PRD.md`, `PRDs/PR1.6_Product_PRD.md`
**Research Source**: `docs/research/2025-12-04-PR1.6-FEATURE-PARITY-ANALYSIS.md`

---

## Overview

The PR1.6 PRDs capture approximately **85-90%** of the original research findings. This document identifies gaps that implementation agents should be aware of to avoid issues during development.

---

## High Severity Gaps

### 1. Missing `updated_at` Column in Schema

**Location**: Tech PRD Phase 4, line 529-536

**Problem**: The new server action uses a column that doesn't exist:
```sql
UPDATE workspace_chat
SET response = $1, is_complete = $2, updated_at = NOW()  -- updated_at doesn't exist!
WHERE id = $3
```

**Research Finding**: The `workspace_chat` table schema at `testdata/init-scripts-merged.sql:25` does NOT include an `updated_at` column.

**Fix Options**:
1. Remove `updated_at` from the query
2. Add schema migration to create the column
3. Use only `is_complete` update without timestamp

---

### 2. File Explorer Real-Time Updates Mechanism Missing

**Location**: Tech PRD Phase 3, Acceptance Criteria

**Problem**: The PRD states "Files update when AI makes changes via textEditor tool" but provides no mechanism for this to happen.

**Research Finding**: The `textEditor` tool calls Go backend → modifies database → but nothing notifies the frontend of changes.

**Fix Options**:
1. **Re-fetch workspace** after tool call completes (simplest)
   ```typescript
   // After tool result received
   const updatedWorkspace = await getWorkspaceAction(session, workspaceId);
   setWorkspace(updatedWorkspace);
   ```
2. **Optimistic update** - parse tool result and update atoms directly
3. **Polling** - periodically refetch (not recommended)

**Recommended**: Option 1 (re-fetch) for PR1.6; optimize in PR1.7 with Centrifugo.

---

## Medium Severity Gaps

### 3. Derived Atoms Misunderstanding

**Location**: Tech PRD Phase 3, lines 375-379

**Problem**: The PRD shows importing and setting `chartsAtom` and `looseFilesAtom`:
```typescript
import { workspaceAtom, chartsAtom, looseFilesAtom } from "@/atoms/workspace";
const setCharts = useSetAtom(chartsAtom);
```

**Research Finding**: `chartsAtom` and `looseFilesAtom` are **derived atoms** (read-only) at `atoms/workspace.ts:95-105`. They automatically derive from `workspaceAtom`.

**Correct Pattern**:
```typescript
// Only need to set workspaceAtom
const setWorkspace = useSetAtom(workspaceAtom);

useEffect(() => {
  setWorkspace(workspace);
  // charts and looseFiles automatically derive - no need to set them
}, [workspace]);
```

---

### 4. Message Format Conversion Missing

**Location**: Tech PRD Phase 4, "Load Existing Messages"

**Problem**: The PRD shows fetching messages and passing to client, but doesn't address format incompatibility.

**Research Finding**:
- Database stores `ChatMessage` format (from `lib/workspace/chat.ts`)
- AI SDK expects `UIMessage` format (from `@ai-sdk/react`)

These have different structures:
```typescript
// ChatMessage (database)
{ id, prompt, response, createdAt, ... }

// UIMessage (AI SDK)
{ id, role, content, parts, ... }
```

**Fix Options**:
1. Convert `ChatMessage[]` to `UIMessage[]` before passing to `useChat`
2. Display persisted messages separately from AI SDK messages
3. Only persist, don't reload (lose history on refresh but simpler)

**Recommended**: Option 2 for PR1.6 - display persisted messages in a "History" section above the AI SDK chat.

---

### 5. Authentication Session Migration

**Location**: Tech PRD Phase 3

**Problem**: The PRD shows server/client split but doesn't address auth migration.

**Research Finding**: Current test page uses `useSession()` hook (client-side). New pattern needs:
1. Server component calls `getSession()`
2. Pass session as prop to client component

**Migration Required**:
```typescript
// OLD (client-side hook)
const { session } = useSession();

// NEW (server-provided prop)
export function TestAIChatClient({ session }: { session: Session }) {
  // Use session directly
}
```

---

### 6. Go Backend Side Effect on Chat Persistence

**Location**: Tech PRD Phase 4

**Problem**: The PRD doesn't mention that `createChatMessageAction` triggers Go backend processing.

**Research Finding**: At `lib/workspace/workspace.ts:229-233`:
```typescript
if (!params.knownIntent) {
  await enqueueWork("new_intent", { chatMessageId, workspaceId });
}
```

This means:
- Every persisted message triggers Go's intent classification
- Go backend MUST be running for persistence to work
- May cause unexpected behavior if Go processes AI SDK messages

**Additional Finding**: The `createChatMessageAction` at `lib/workspace/actions/create-chat-message.ts` only accepts 4 parameters (`session`, `workspaceId`, `message`, `messageFromPersona`) - there is no `knownIntent` parameter. Option 1 is not viable without modifying the existing action.

**Fix Options**:
1. ~~Pass `knownIntent: ChatMessageIntent.NON_PLAN` to skip intent processing~~ (not possible - action doesn't accept this param)
2. Create new "AI SDK only" persistence action that skips enqueue ✅
3. Accept the side effect (messages get classified by Go)

**Resolution**: Option 2 implemented - PRDs updated to create `createAISDKChatMessageAction` that inserts directly into `workspace_chat` table with `ChatMessageIntent.NON_PLAN` preset, bypassing the `enqueueWork` call entirely.

---

## Low Severity Gaps

### 7. Missing `*BeforeApplyingContentPending` Atom Hydration

**Location**: Tech PRD Phase 3 atom hydration

**Problem**: Main path hydrates additional atoms for file diff tracking.

**Research Finding**: At `WorkspaceContent.tsx:61-62`:
```typescript
setChartsBeforeApplyingContentPending(initialWorkspace.charts);
setLooseFilesBeforeApplyingContentPending(initialWorkspace.files);
```

**Impact**: File diff display (showing +N/-N changes) won't work without these.

**Recommendation**: Add if file diff display is needed; otherwise defer to PR1.7.

---

### 8. `selectedFileAtom` Integration Missing

**Location**: Tech PRD Phase 3

**Problem**: PRD shows `FileBrowser` but doesn't explain file selection behavior.

**Research Finding**: `FileBrowser` uses `selectedFileAtom` to track selection. Clicking files updates this atom, but:
- No code viewer panel in test path
- Unclear what should happen on file click

**Recommendation**: Either add code viewer or document that file selection is visual-only in PR1.6.

---

### 9. Tool Result UI Already Exists

**Location**: Tech PRD Phase 1

**Problem**: PRD implies tool result display needs implementation.

**Research Finding**: Test page already has tool rendering at lines 186-200:
```typescript
if (part.type === 'tool-invocation') {
  return (
    <div key={i}>
      <span>{part.toolInvocation.toolName}</span>
      <span>({part.toolInvocation.state})</span>
      {part.toolInvocation.state === 'result' && (
        <pre>{JSON.stringify(part.toolInvocation.result, null, 2)}</pre>
      )}
    </div>
  );
}
```

**Recommendation**: Phase 1 should include verification step, not new implementation.

---

### 10. CSS Line Number Accuracy

**Location**: Tech PRD Phase 5

**Problem**: PRD references "line 181" which may be outdated after other changes.

**Research Finding**: Actual location is lines 175-185 in current codebase.

**Recommendation**: Verify line numbers before implementation; search for `prose prose-sm` instead.

---

## Summary Table

| # | Gap | Severity | PRD Section | Fix Complexity |
|---|-----|----------|-------------|----------------|
| 1 | Missing `updated_at` column | **High** | Phase 4 | Low (remove from query) |
| 2 | File explorer updates mechanism | **High** | Phase 3 | Medium (add refetch) |
| 3 | Derived atoms misunderstanding | Medium | Phase 3 | Low (simplify code) |
| 4 | Message format conversion | Medium | Phase 4 | Medium (add converter) |
| 5 | Auth session migration | Medium | Phase 3 | Low (document pattern) |
| 6 | Go backend side effect | Medium | Phase 4 | Low (pass knownIntent) |
| 7 | Missing diff tracking atoms | Low | Phase 3 | Low (add if needed) |
| 8 | selectedFileAtom integration | Low | Phase 3 | Defer to PR1.7 |
| 9 | Tool result UI exists | Low | Phase 1 | Low (add verification) |
| 10 | CSS line numbers | Low | Phase 5 | Low (verify first) |

---

## Recommended PRD Updates

### Must Fix Before Implementation

1. **Phase 4**: Remove `updated_at` from UPDATE query
2. **Phase 3**: Add file explorer update mechanism (refetch after tool calls)
3. **Phase 3**: Fix atom hydration to only set `workspaceAtom`

### Should Fix Before Implementation

4. **Phase 4**: Add message format note (display separately or convert)
5. **Phase 4**: Add `knownIntent` parameter to skip Go processing
6. **Phase 3**: Document session migration from hook to prop

### Can Fix During Implementation

7-10: Low severity items can be addressed as encountered

---

## Code Snippets for Fixes

### Fix #1: Remove updated_at

```typescript
// lib/workspace/actions/update-chat-message-response.ts
await db.query(
  `UPDATE workspace_chat
   SET response = $1, is_intent_complete = $2
   WHERE id = $3`,
  [response, isComplete, chatMessageId]
);
```

### Fix #2: File Explorer Updates

```typescript
// In TestAIChatClient, after tool result
useEffect(() => {
  const lastMessage = messages[messages.length - 1];
  const hasToolResult = lastMessage?.parts?.some(
    p => p.type === 'tool-invocation' && p.toolInvocation.state === 'result'
  );

  if (hasToolResult && status === 'ready') {
    // Refetch workspace to get updated files
    getWorkspaceAction(session, workspace.id).then(setWorkspace);
  }
}, [messages, status]);
```

### Fix #3: Correct Atom Hydration

```typescript
// Only set workspaceAtom - charts/files derive automatically
const setWorkspace = useSetAtom(workspaceAtom);

useEffect(() => {
  setWorkspace(workspace);
}, [workspace, setWorkspace]);
```

### Fix #6: Skip Go Intent Processing

**UPDATED**: Create new server action instead of modifying existing one (existing action only accepts 4 params):

```typescript
// lib/workspace/actions/create-ai-sdk-chat-message.ts
"use server";

import { Session } from "@/lib/types/session";
import { getDB, getParam } from "@/lib/db";
import { ChatMessage, ChatMessageFromPersona, ChatMessageIntent } from "@/lib/workspace/chat";
import { v4 as uuidv4 } from "uuid";

export async function createAISDKChatMessageAction(
  session: Session,
  workspaceId: string,
  message: string
): Promise<ChatMessage> {
  if (!session?.user?.id) {
    throw new Error("Unauthorized");
  }

  const db = getDB(await getParam("DB_URI"));
  const id = uuidv4();
  const now = new Date();

  // Insert directly, skipping enqueueWork("new_intent") call
  await db.query(
    `INSERT INTO workspace_chat (id, workspace_id, prompt, response, created_at, message_from_persona, intent, is_intent_complete)
     VALUES ($1, $2, $3, $4, $5, $6, $7, $8)`,
    [id, workspaceId, message, null, now, ChatMessageFromPersona.AUTO, ChatMessageIntent.NON_PLAN, true]
  );

  return {
    id, workspaceId, prompt: message, response: null, createdAt: now,
    messageFromPersona: ChatMessageFromPersona.AUTO,
    intent: ChatMessageIntent.NON_PLAN, isIntentComplete: true
  } as ChatMessage;
}
```

Usage in client:
```typescript
import { createAISDKChatMessageAction } from "@/lib/workspace/actions/create-ai-sdk-chat-message";

const chatMessage = await createAISDKChatMessageAction(session, workspace.id, chatInput.trim());
```

---

## Related Documents

- `PRDs/PR1.6_Tech_PRD.md` - Technical specification (updated)
- `PRDs/PR1.6_Product_PRD.md` - Product requirements (complete)
- `docs/research/2025-12-04-PR1.6-FEATURE-PARITY-ANALYSIS.md` - Original research
- `chartsmith/docs/PR1.5_KNOWN_ISSUES.md` - Issue documentation
- `agent-prompts/PR1.6_SUB_AGENT.md` - Implementation prompt (updated)

---

*This document should be referenced by implementation agents alongside the PR1.6 PRDs.*
